<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ssh-agent for sudo authentication with a passwordless account - mike.depalatis.net</title>
<link rel="stylesheet" href="/css/inter.css">
<link rel="stylesheet" href="/css/new.css">
<link rel="stylesheet" href="/css/codehilite.css">
</head>
<body>
<header>
<h1>mike.depalatis.net</h1>
<nav>
<a href="/index.html">Home</a>
/
<a href="/blog/index.html">Articles</a>
/
<a href="/resources.html">Resources</a>
</nav>
</header>


<h1>ssh-agent for sudo authentication with a passwordless account</h1>
<p>For best security on a public system, it is generally best to disable
password-based logins with ssh and instead require authorized
keys. However, this complicates things if you want to use <code>sudo</code>
with a regular user account, since by default it uses the standard
system password to verify the user is authorized to run commands as
root.</p>
<p>Enter <code>pam_ssh_agent_auth</code>. This module allows using regular ssh keys
and <code>ssh-agent</code> to verify the user has the proper authorization to
use <code>sudo</code>.</p>
<h2>Prerequisites</h2>
<p>You'll want to start by ensuring you have generated ssh keys for your
user and are using <code>ssh-agent</code>. To generate the keys:</p>
<div class="codehilite"><pre><span></span><code>$ ssh-keygen
</code></pre></div>

<p>Then just accept the defaults, but make sure to set a password for
your new key pair. Add the public key to
<code>$HOME/.ssh/authorized_keys</code>.</p>
<h2>Installation</h2>
<p>Since the PAM module isn't in Debian, first grab the build
dependencies:</p>
<div class="codehilite"><pre><span></span><code># apt-get install build-essential checkinstall libssl-dev libpam0g-dev
</code></pre></div>

<p>Next, grab the source and build:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># wget http://downloads.sourceforge.net/project/pamsshagentauth/pam_ssh_agent_auth/v0.10.2/pam_ssh_agent_auth-0.10.2.tar.bz2</span><span class="w"></span>
<span class="c1"># tar -xvjf pam_ssh_agent_auth-0.10.2.tar.bz2</span><span class="w"></span>
<span class="c1"># cd pam_ssh_agent_auth-0.10.2</span><span class="w"></span>
<span class="c1"># ./configure --libexecdir=/lib/security --with-mantype=man</span><span class="w"></span>
<span class="c1"># make</span><span class="w"></span>
<span class="c1"># checkinstall</span><span class="w"></span>
</code></pre></div>

<p>Note that the <code>libexecdir</code> option to the <code>configure</code> script is set
since apparently Debian keeps PAM modules in a different place than
<code>pam_ssh_agent_auth</code> expects by default.</p>
<h2>Configuration</h2>
<p>Edit the file <code>/etc/pam.d/sudo</code> and add the following line <em>before</em>
any other <code>auth</code> or <code>@include</code> commands:</p>
<div class="codehilite"><pre><span></span><code><span class="na">auth sufficient pam_ssh_agent_auth.so file</span><span class="o">=</span><span class="s">~/.ssh/authorized_keys</span><span class="w"></span>
</code></pre></div>

<p>Run <code>visudo</code> to edit <code>/etc/sudoers</code> and add this line before any
other <code>Defaults</code> lines:</p>
<div class="codehilite"><pre><span></span><code><span class="na">Defaults env_keep +</span><span class="o">=</span><span class="w"> </span><span class="s">SSH_AUTH_SOCK</span><span class="w"></span>
</code></pre></div>

<h2>Invoking <code>sudo</code></h2>
<p>To actually be able to use <code>sudo</code> now, run <code>ssh-agent</code> like so:</p>
<div class="codehilite"><pre><span></span><code>$ <span class="nb">eval</span> <span class="sb">`</span>ssh-agent<span class="sb">`</span>
</code></pre></div>

<p>and add the key:</p>
<div class="codehilite"><pre><span></span><code>$ ssh-add -t <span class="m">600</span>
</code></pre></div>

<p>This will set the keys to timeout in 10 minutes (600 seconds).</p>
<h2>TODO</h2>
<p>A more elegant way of adding keys and running <code>ssh-agent</code>, including
checking to see if a process is already running!</p>
<h2>References</h2>
<ol>
<li><a href="http://unix.stackexchange.com/a/158452">How to allow authentication with sudo using an alternate password?</a></li>
<li><a href="http://www.evans.io/posts/ssh-agent-for-sudo-authentication/">Using SSH agent for sudo authentication</a></li>
<li><a href="http://mah.everybody.org/docs/ssh">Using ssh-agent with ssh</a></li>
</ol>

</body>
</html>
