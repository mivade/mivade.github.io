<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Michael V. DePalatis">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Background tasks with Tornado - mike.depalatis.net</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/color-brewer.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../index.html">mike.depalatis.net</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../index.html">About</a>
                            </li>
                            <li >
                                <a href="../resources.html">Resources</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Blog <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../archives.html">Archives</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">2018</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="conda-kernels.html">Jupyter integration with conda environments</a>
</li>
            
<li >
    <a href="multiline-lambdas.html">Multiline lambdas</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">2017</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="ipc-with-sqlite.html">Sharing data between processes with SQLite</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">2016</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="lmfit.html">Fitting with lmfit</a>
</li>
            
<li >
    <a href="matplotlib-color-cycle.html">Getting Matplotlib's colors in order</a>
</li>
            
<li >
    <a href="postgres-time-series-database.html">Using Postgres as a time series database</a>
</li>
            
<li >
    <a href="simplifying-argparse.html">Simplifying argparse usage with subcommands</a>
</li>
            
<li >
    <a href="javascript-for-python-programmers.html">Javascript for Python programmers</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">2015</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="blocking-code-to-tornado-coroutine.html">Running (possibly) blocking code like a Tornado coroutine</a>
</li>
            
<li class="active">
    <a href="tornado-background-tasks.html">Background tasks with Tornado</a>
</li>
            
<li >
    <a href="flask-sse-demo.html">Flask and server-sent events</a>
</li>
            
<li >
    <a href="hg-import-from-another-repo.html">Importing one Mercurial repository into another</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">2014</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="rpi-usb-ethernet-gateway.html">Raspberry Pi as a USB to Ethernet Gateway</a>
</li>
            
<li >
    <a href="sudo-ssh-auth.html">ssh-agent for sudo authentication with a passwordless account</a>
</li>
            
<li >
    <a href="flask-websockets-with-tornado.html">Using websockets with Flask via Tornado</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="blocking-code-to-tornado-coroutine.html">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="flask-sse-demo.html">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
    <div class="col-md-12" role="main">


<h1>Background tasks with Tornado</h1>

<p>I have been using <a href="http://www.tornadoweb.org/en/stable/">Tornado</a> lately for distributed control of
devices in the lab where an asynchronous framework is advantageous. In
particular, we have a <a href="http://www.highfinesse.com/">HighFinesse</a> <a href="http://www.highfinesse.com/en/wavelengthmeter/">wavelength meter</a>
which we use to monitor and stabilize several lasers (up to 14 at a
time). Previously, a custom server for controlling this wavemeter was
written using <a href="https://twistedmatrix.com/trac/">Twisted</a>, but that has proven difficult to upgrade,
distribute, and maintain.</p>
<p>One thing that is common for such a control scenario is that data
needs to be refreshed continuously while still allowing incoming
connections from clients and appropriately executing remote procedure
calls. One method would be to periodically interrupt the Tornado IO
loop to refresh data (and in fact, Tornado has a class to make this
easy for you in <code>tornado.ioloop.PeriodicCallback</code>). This can be fine
if the data refreshing does not take too much time, but all other
operations will be blocked until the callback is finished, which can
be a problem if the refreshing operation is slow. Another option is to
have an additional thread separate from the Tornado IO loop that
handles refreshing data. This certainly works, but adds the complexity
of needing to use thread-safe communications to stop the thread when
the main application is shut down or when other tasks depend on the
successful completion of the refresh.</p>
<p>Luckily, Tornado also includes a decorator,
<code>tornado.concurrent.run_on_executor</code>, to run things in the background
for you using Python's <code>concurrent.futures</code> module (which is standard
starting in Python 3.3 and backported for other versions). Then
instead of writing the refresh function as a loop that runs in the
background, you instead have its final call be to add itself back as a
callback on the IO loop. This makes shutdown trivial since only the IO
loop needs to be stopped when the program is closed. A refresh
function could thus look something like this:</p>
<pre><code class="python">@tornado.concurrent.run_on_executor
def refresh():
    do_something_that_takes_a_while()
    tornado.ioloop.IOLoop.instance().add_callback(self.refresh)
</code></pre>

<p>Now after <code>refresh</code> is called once, it will continuously run until the
IO loop is stopped.</p>
<p>For a more complete example, I have written a small <a href="https://gist.github.com/mivade/421c427db75c8c5fa1d1">demo</a>.</p></div>

        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
